---
title: "Fluctuation Amplitude Development Unfolds Hierarchically Along the Sensorimotor-Association Axis"
author: "Valerie Jill Sydnor"
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
library(cifti)
library(ggseg)
library(ggsegExtra)
library(ggsegGlasser)
library(dplyr)
library(stringr)
library(factoextra)
library(matrixStats)
library(scales)
library(Hmisc)
library(tidyr)
source("/cbica/projects/spatiotemp_dev_plasticity/software/rotate_parcellation/R/perm.sphere.p.R")
```

Participant Fluctuation Amplitude Data
```{r}
fluctuations.glasser.pnc <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/FluctuationAmplitude/PNC/glasserfluctuations_demographics_finalsample.csv") #fMRI + demographics, generated with fitGAMs_fluctuationamplitude_age.R
```

Glasser Labels
```{r}
glasser.parcel.labels <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/Maps/parcellations/surface/glasser360_regionlist.csv", header = T)
```

Sensorimotor-Association Axis
```{r, warning=F, message=F}
S.A.axis.cifti <- read_cifti("/cbica/projects/spatiotemp_dev_plasticity/Maps/S-A_ArchetypalAxis/FSLRVertex/SensorimotorAssociation_Axis_parcellated/SensorimotorAssociation.Axis.Glasser360.pscalar.nii") #S-A_ArchetypalAxis repo
S.A.axis <- as.data.frame(cbind(rank(S.A.axis.cifti$data), names(S.A.axis.cifti$Parcel)))
colnames(S.A.axis) <- c("SA.axis","orig_parcelname")
S.A.axis <- merge(S.A.axis, glasser.parcel.labels, by="orig_parcelname", sort = F)
S.A.axis$SA.axis <- as.numeric(S.A.axis$SA.axis)
rm(S.A.axis.cifti)
```

Intracortical Myelination Developmental Data
```{r message=FALSE, warning=FALSE}
myelin.partialR2.cifti <- read_cifti("/cbica/projects/spatiotemp_dev_plasticity/Myelin/hcpd_n628_myelin_sAge_partial_bayes_r2.pscalar.nii")
myelin.maxdev.cifti <- read_cifti("/cbica/projects/spatiotemp_dev_plasticity/Myelin/hcpd_n628_median_posterior_age_of_max_slope_myelination.pscalar.nii")
myelin <- as.data.frame(cbind(myelin.partialR2.cifti$data, myelin.maxdev.cifti$data))
colnames(myelin) <- c("myelin.partialR2","myelin.maxdev")
myelin$label <- glasser.parcel.labels$label
rm(myelin.partialR2.cifti)
rm(myelin.maxdev.cifti)
```

SNR Mask
```{r}
SNR.mask <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/Maps/parcellations/surface/SNRmask_glasser360.csv")
```

Spin Test Parcel Rotation Matrix
```{r eval=FALSE, include=TRUE}
source("/cbica/projects/spatiotemp_dev_plasticity/software/rotate_parcellation/R/rotate.parcellation.R")
source("/cbica/projects/spatiotemp_dev_plasticity/software/rotate_parcellation/R/perm.sphere.p.R")
glasser.coords <- read.table("/cbica/projects/spatiotemp_dev_plasticity/software/rotate_parcellation/sphere_HCP.txt", header=F) #coordinates of glasser parcel centroids on the freesurfer sphere
perm.id.full <- rotate.parcellation(coord.l = as.matrix(glasser.coords[1:180,]), coord.r = as.matrix(glasser.coords[181:360,]), nrot = 10000) #rotate the glasser parcellation 10,000 times on the freesurfer sphere to generate spatial nulls for spin-based permutation significance testing 
saveRDS(perm.id.full, "/cbica/projects/spatiotemp_dev_plasticity/software/rotate_parcellation/glasser_sphericalrotations_N10000.rds")
```
```{r}
perm.id.full <- readRDS("/cbica/projects/spatiotemp_dev_plasticity/software/rotate_parcellation/glasser_sphericalrotations_N10000.rds")
```

GAM Results
```{r}
gam.age.glasser <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/FluctuationAmplitude/GAMRESULTS/fluctuationamplitude_age_statistics_glasser.csv") #GAM age smooth statistics, generated with fitGAMs_fluctuationamplitude_age.R

#create df.dev with GAM statistics, S-A axis, plasticity measures, and SNR mask
df.list <- list(gam.age.glasser, S.A.axis, myelin, SNR.mask) #dfs to merge
df.dev <- Reduce(function(x,y) merge(x,y, all=TRUE, sort=F), df.list) 
df.dev <- df.dev %>% select(label, orig_parcelname, everything()) #order columns
cols = c(3:15)    
df.dev[,cols] = apply(df.dev[,cols], 2, function(x) as.numeric(as.character(x))) #format numerics

#create df.dev.spin formatted for spatial permutation testing
df.dev.spin <- rbind(df.dev[181:360,], df.dev[1:180,]) #format df as left hemisphere -> right hemisphere for spin tests
df.dev.spin$GAM.age.partialR2[df.dev.spin$SNR.mask == 0] <- NA #format data for spin tests by assigning NA to low SNR parcels, treating them like the medial wall
df.dev.spin$minage.decrease[df.dev.spin$SNR.mask == 0] <- NA 

df.dev <- df.dev %>% filter(SNR.mask != 0) #include only high SNR parcels (N=336) in analyses
df.dev$SA.axis.bin <- as.numeric(cut2(df.dev$SA.axis, g=10)) #divide the S-A axis into 10 ranked bins
```

```{r}
gam.fitted.glasser <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/FluctuationAmplitude/GAMRESULTS/fluctuationamplitude_age_predictedfits_glasser.csv") #GAM predicted fits, generated with fitGAMs_fluctuationamplitude_age.R
gam.fitted.glasser <- merge(gam.fitted.glasser, df.dev, by="label", sort = F)
```

```{r}
gam.smoothestimates.glasser <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/FluctuationAmplitude/GAMRESULTS/fluctuationamplitude_age_smoothestimates_glasser.csv") #GAM smooth estimates, generated with fitGAMs_fluctuationamplitude_age.R
gam.smoothestimates.glasser <- merge(gam.smoothestimates.glasser, df.dev, by="label", sort = F)
```

```{r}
gam.derivatives.glasser <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/FluctuationAmplitude/GAMRESULTS/fluctuationamplitude_age_derivatives_glasser.csv")
gam.derivatives.glasser <- left_join(gam.derivatives.glasser, S.A.axis, by="label", sort = F)
gam.derivatives.glasser <- left_join(gam.derivatives.glasser, SNR.mask, by="label", sort = F)
gam.derivatives.glasser <- gam.derivatives.glasser %>% filter(SNR.mask != 0) #include only high SNR parcels (N=336) in analyses
```

```{r}
gam.env.glasser <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/FluctuationAmplitude/GAMRESULTS/fluctuationamplitude_environment_statistics_glasser.csv") #GAM environment statistics, generated with fitGAMs_fluctuationamplitude_environment.R

#create df.env with GAM results, S-A axis, and SNR mask
df.list <- list(gam.env.glasser, S.A.axis, SNR.mask) #dfs to merge
df.env <- Reduce(function(x,y) merge(x,y, all=TRUE, sort=F), df.list) 

#create df.env.spin formatted for spatial permutation testing
df.env.spin <- rbind(df.env[181:360,], df.env[1:180,]) #format df as left hemisphere -> right hemisphere for spin tests
df.env.spin$GAM.env.tvalue[df.env.spin$SNR.mask == 0] <- NA #format data for spin tests by assigning NA to low SNR parcels, treating them like the medial wall

df.env <- df.env %>% filter(SNR.mask != 0) #include only high SNR parcels (N=336) in analyses
```

# Age-Dependent Changes in Spontaneous Fluctuations Vary Across the Cortex

## Significant age-related changes in fluctuation amplitude

Number of cortical regions showing significant age effects
```{r}
sum(p.adjust(df.dev$Anova.age.pvalue, method=c("fdr")) < 0.05) #FDR-corrected p-values from full versus reduced age models
```

Percent of cortical regions showing significant age effects
```{r}
(sum(p.adjust(df.dev$Anova.age.pvalue, method=c("fdr")) < 0.05))/(nrow(df.dev))*100 
```

Across-cortex effect size and (mean derivative) direction
```{r, warning=F, message=F}
ggseg(.data = df.dev, atlas = "glasser", mapping=aes(fill=GAM.age.partialR2), position = c("stacked")) + 
  theme_void() + 
  labs(fill="Age Effect") +
  paletteer::scale_fill_paletteer_c("pals::ocean.matter", direction = -1, limits = c(-0.07, .03), oob = squish) 
```

## Cortical smooth functions

```{r}
gam.smoothestimates.glasser.lh <- gam.smoothestimates.glasser[33401:67200,]
ggplot(gam.smoothestimates.glasser.lh,aes(age,est,group=index,color=GAM.age.partialR2)) + 
  geom_line(size=.8, alpha = .8) + 
  paletteer::scale_color_paletteer_c("pals::ocean.matter", direction = -1, limits = c(-0.07, .03), oob = squish) +
  theme_classic() +
  labs(x = "\nAge", y = "Fluctuation Amplitude (zero centered)\n" ) +
  theme(legend.position = "none") +
  theme(axis.text = element_text(size=22, family = "Arial", color = c("black")), axis.title = element_text(size=21, family = "Arial", color = c("black"))) +
  scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), expand = c(0,.45)) 
```

### Region-specific smooths

#### V1

```{r}
V1.smooth <- gam.fitted.glasser %>% filter(label == "rh_R_V1")
V1.derivatives <- gam.derivatives.glasser %>% filter(label == "rh_R_V1")

ggplot(data = fluctuations.glasser.pnc, aes(x = age, y = rh_R_V1)) +
  geom_point(color="#FBDC9D") +
  geom_line(data = V1.smooth, aes(x = age, y = fitted), color="#F8B57B", size=2) +
  geom_ribbon(data = V1.smooth, aes(x = age, y = fitted,  ymin = lower, ymax = upper) ,alpha = .7, linetype = 0, fill="#F8B87D",) +
  labs(x="\nAge", y="Fluctuation Amplitude\n") +
  theme_classic() +
  theme(
  axis.text = element_text(size=15, family = "Arial", color = c("black")),
  axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
  axis.title.y=element_text(size=15, family ="Arial", color = c("black"))) +
  scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), expand = c(0,.45)) +
  scale_y_continuous(breaks=c(0.5, 1, 1.5, 2, 2.5, 3))

ggplot(data = V1.derivatives) + 
  geom_tile(aes(x = age, y = .1, fill = significant.derivative)) +
  scale_fill_gradient(low = "#EFAF77", high = "#FFE0A1", limits = c(-0.0323371,-.01), na.value = "white") +
  labs(x="\nAge", fill = "Derivative") + 
  theme_classic() +
  theme(axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.line = element_blank(),
          axis.ticks.y = element_blank(),
          axis.title.x=element_text(size=15, family ="Arial", color = c("black")))
```

#### p24pr

```{r}
p24pr.smooth <- gam.fitted.glasser %>%filter(label == "rh_R_p24pr")
p24pr.derivatives <- gam.derivatives.glasser %>% filter(label == "rh_R_p24pr")

ggplot(data = fluctuations.glasser.pnc, aes(x = age, y = rh_R_p24pr)) +
  geom_point(color="#DF5E54") +
  geom_line(data = p24pr.smooth, aes(x = age, y = fitted), color="#D54D55", size=2) +
  geom_ribbon(data = p24pr.smooth, aes(x = age, y = fitted,  ymin = lower, ymax = upper) ,alpha = .7, linetype = 0, fill="#D54D55",) +
  labs(x="\nAge", y="Fluctuation Amplitude\n") +
  theme_classic() +
  theme(
  axis.text = element_text(size=15, family = "Arial", color = c("black")),
  axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
  axis.title.y=element_text(size=15, family ="Arial", color = c("black"))) +
  scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), expand = c(0,.45)) +
  scale_y_continuous(breaks=c(0.5, 1, 1.5, 2, 2.5, 3))

ggplot(data = p24pr.derivatives) + 
  geom_tile(aes(x = age, y = .5, fill = significant.derivative)) +
  scale_fill_gradient(high = alpha("#DF5E54",0.7), low = "#D54D55", na.value = "white", limits = c(min(p24pr.derivatives$significant.derivative),-.001)) +
  labs(x="\nAge", fill = "Derivative") + 
  theme_classic() +
  theme(axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.line = element_blank(),
          axis.ticks.y = element_blank(),
          axis.title.x=element_text(size=15, family ="Arial", color = c("black")))
  
```

#### IFSa

```{r}
#rh_R_9m
IFSa.smooth <- gam.fitted.glasser %>%filter(label == "lh_L_IFSa")
IFSa.derivatives <- gam.derivatives.glasser %>% filter(label == "lh_L_IFSa")

ggplot(data = fluctuations.glasser.pnc, aes(x = age, y = lh_L_IFSa)) +
  geom_point(color="#6E195E") +
  geom_line(data = IFSa.smooth, aes(x = age, y = fitted), color="#381043", size=2) +
  geom_ribbon(data = IFSa.smooth, aes(x = age, y = fitted,  ymin = lower, ymax = upper) ,alpha = .7, linetype = 0, fill="#381043",) +
  labs(x="\nAge", y="Fluctuation Amplitude\n") +
  theme_classic() +
  theme(
  axis.text = element_text(size=15, family = "Arial", color = c("black")),
  axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
  axis.title.y=element_text(size=15, family ="Arial", color = c("black"))) +
  scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), expand = c(0,.45)) +
  scale_y_continuous(breaks=c(0.5, 1, 1.5, 2, 2.5, 3))

ggplot(data = IFSa.derivatives) + 
  geom_tile(aes(x = age, y = .5, fill = significant.derivative)) +
  scale_fill_gradient2(high = "#6E195E", low = "#cf93c4", midpoint = 0, mid = "white", na.value = "white") +
  labs(x="\nAge", fill = "Derivative") + 
  theme_classic() +
  theme(axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.line = element_blank(),
          axis.ticks.y = element_blank(),
          axis.title.x=element_text(size=15, family ="Arial", color = c("black")))
  
```

# Spatiotemporal Development of Fluctuation Amplitude Mirrors Intracortical Myelin Growth  

## Spatial development

Fluctuation amplitude age effects map
```{r, warning=F, message=F}
ggseg(.data = df.dev, atlas = "glasser", mapping=aes(fill=GAM.age.partialR2), position = c("stacked"), hemisphere = "right") + 
  theme_void() + 
  labs(fill="Age Effect") +
  paletteer::scale_fill_paletteer_c("pals::ocean.matter", direction = -1, limits = c(-0.07, .03), oob = squish)
```

T1/T2 ratio age effects map
```{r}
ggseg(.data = df.dev, atlas = "glasser", mapping=aes(fill=myelin.partialR2), position = c("stacked"), hemisphere = "right") + 
  theme_void() + 
  labs(fill="Age Effect") +
  paletteer::scale_fill_paletteer_c("pals::ocean.matter", direction = 1, limits = c(0.0,0.3), oob = squish) 
```

Correlation between fluctuation amplitude age effects and T1/T2 ratio age effects
```{r}
cor.test(df.dev$GAM.age.partialR2, df.dev$myelin.partialR2, method=c("spearman"))
perm.sphere.p(df.dev.spin$GAM.age.partialR2, df.dev.spin$myelin.partialR2, perm.id.full,corr.type='spearman')
```

Correlation plot
```{r}
ggplot(df.dev, aes(x=myelin.partialR2, y=GAM.age.partialR2, fill = myelin.partialR2)) + 
geom_point(color = "white",shape=21, size=3.7) +
paletteer::scale_fill_paletteer_c("pals::ocean.matter", direction = 1, limits = c(0.0,0.3), oob = squish) +
labs(x="\nMyelin Age Effect", y="Fluctuation Amplitude Age Effect\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")
```

## Temporal development

Fluctuation Amplitude Age of Decrease Onset
```{r, warning=F, message=F}
ggseg(.data = df.dev, atlas = "glasser", mapping=aes(fill=minage.decrease), position = c("stacked"), hemisphere = "right") + 
  theme_void() + 
  labs(fill="Age Decrease Onset") +
  paletteer::scale_fill_paletteer_c("pals::ocean.matter", direction = -1, limits = c(9, 17.5), oob = squish) 
```

T1/T2 ratio Age of Maximal Increase
```{r}
ggseg(.data = df.dev, atlas = "glasser", mapping=aes(fill=myelin.maxdev), position = c("stacked"), hemisphere = "right") + 
  theme_void() + 
  labs(fill="Age Effect") +
  paletteer::scale_fill_paletteer_c("pals::ocean.matter", direction = -1, limits = c(10,17.5), oob = squish) 
```

Correlation between fluctuation amplitude age decrease onset and T1/T2 ratio max age of increase
```{r}
#All regions
cor.test(df.dev$minage.decrease, df.dev$myelin.maxdev, method=c("spearman"))
perm.sphere.p(df.dev.spin$minage.decrease, df.dev.spin$myelin.maxdev, perm.id.full,corr.type='spearman')
#Age of decrease onset > 8.5
late.decrease <- df.dev %>% filter(minage.decrease > 8.5)
cor.test(late.decrease$minage.decrease, late.decrease$myelin.maxdev, method=c("spearman"))
late.decrease.spin <- df.dev.spin
late.decrease.spin$minage.decrease[late.decrease.spin$minage.decrease < 8.5] <- NA
perm.sphere.p(late.decrease.spin$minage.decrease, late.decrease.spin$myelin.maxdev, perm.id.full,corr.type='spearman')
```

Correlation plot
```{r}
ggplot(df.dev, aes(x=myelin.maxdev, y=minage.decrease, fill = myelin.maxdev)) + 
geom_point(color = "white",shape=21, size=3.7) +
paletteer::scale_fill_paletteer_c("pals::ocean.matter",  direction = -1, limits = c(10,17.5), oob = squish) +
labs(x="\nMyelin Age of Maximal Increase", y="Fluctuation Amplitude Age of Decrease Onset\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")

ggplot(late.decrease, aes(x=myelin.maxdev, y=minage.decrease, fill = myelin.maxdev)) + 
geom_point(color = "white",shape=21, size=3.7) +
paletteer::scale_fill_paletteer_c("pals::ocean.matter",  direction = -1, limits = c(10,17.5), oob = squish) +
labs(x="\nMyelin Age of Maximal Increase", y="Fluctuation Amplitude Age of Decrease Onset\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")
```

# Fluctuation Amplitude Development Unfolds along the Hierarchical Sensorimotor-Association Axis

Sensorimotor Association Axis
```{r, warning=F, message=F}
ggseg(.data = df.dev, atlas = "glasser", mapping=aes(fill=SA.axis), position = c("stacked")) + 
  theme_void() + 
  theme(legend.position = "none") +
  scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180)
```

## Age effects along the S-A Axis

Correlation between fluctuation amplitude age effects and the sensorimotor-association axis
```{r}
cor.test(df.dev$GAM.age.partialR2, df.dev$SA.axis, method=c("spearman"))
perm.sphere.p(df.dev.spin$GAM.age.partialR2, df.dev.spin$SA.axis, perm.id.full,corr.type='spearman')
```

Correlation plot
```{r, message=F}
ggplot(df.dev, aes(x=SA.axis, y=GAM.age.partialR2, fill = SA.axis)) + 
geom_point(color = "white",shape=21, size=4.5) +
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180) +
labs(x="\nSensorimtor-Association Axis Rank", y="Fluctuation Amplitude Age Effect\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=24, family ="Arial", color = c("black")),
axis.title.y=element_text(size=24, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=24, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")
```

## Temporal change along the S-A Axis

Correlation between fluctuation amplitude age of decrease onset and the sensorimotor-association axis
```{r}
cor.test(df.dev$minage.decrease, df.dev$SA.axis, method=c("spearman"))
perm.sphere.p(df.dev.spin$minage.decrease, df.dev.spin$SA.axis, perm.id.full,corr.type='spearman')
cor.test(late.decrease$minage.decrease, late.decrease$SA.axis, method=c("spearman"))
perm.sphere.p(late.decrease.spin$minage.decrease, late.decrease.spin$SA.axis, perm.id.full,corr.type='spearman')
```

Correlation plot
```{r}
ggplot(df.dev, aes(x=SA.axis, y=minage.decrease, fill = SA.axis)) + 
geom_point(color = "white",shape=21, size=3.7) +
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180) +
labs(x="\nSensorimtor-Association Axis", y="Fluctuation Amplitude Age of Decrease Onset\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")

ggplot(late.decrease, aes(x=SA.axis, y=minage.decrease, fill = SA.axis)) + 
geom_point(color = "white",shape=21, size=3.7) +
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180) +
labs(x="\nSensorimtor-Association Axis", y="Fluctuation Amplitude Age of Decrease Onset\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")
```

S-A axis binned GAM smooths 
```{r}
gam.smoothestimates.glasser$age <- round(gam.smoothestimates.glasser$age, 3)

meansmooth.bins <- gam.smoothestimates.glasser %>% group_by(age, SA.axis.bin) %>% do(est.mean = mean(.$est)) %>% unnest(cols = c(est.mean)) #calculate the average smooth estimate at each age within each of the 10 bins
```

```{r}
ggplot(data = meansmooth.bins, aes(x = age, y = est.mean, group = SA.axis.bin, color = as.factor(SA.axis.bin))) +
  geom_line(size = 2.5) +
  scale_color_manual(values = c("#FFC228", "#FFCA4E", "#FFD16A", "#FFDA89", "#FFE6B0", "#D7BCDA", "#BE93C4", "#9859A4", "#863E95", "#6F1382")) +
  theme_classic() +
  labs(x = "\nAge", y = "Fluctuation Amplitude (zero centered)\n", color = "Sensorimotor-Association Axis Bin") +
  theme(axis.text = element_text(size=15, family = "Arial", color = c("black")), axis.title = element_text(size=15, family = "Arial", color = c("black"))) +
  theme(legend.position = c(.57, 0.94), legend.direction = "horizontal", legend.text = element_text(size=13), legend.title = element_text(size=12, family = "Arial", color = c("black"))) +
  scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), expand = c(0,.45))
```

## Principal developmental gradient

```{r}
gam.estimated.smooths.glasser <- gam.estimated.smooths.glasser %>% select(label, age, est)

gam.estimated.smooths.long <- spread(gam.estimated.smooths.glasser, age, est) #convert long df to wide, rows are regions and columns are age
gam.estimated.smooths.long <- t(gam.estimated.smooths.long) #transpose such that rows are age and columns are regions
colnames(gam.estimated.smooths.long) <- gam.estimated.smooths.long[1,] #name columns
gam.estimated.smooths.long <- gam.estimated.smooths.long[-1,] #200 ages by 360 regions matrix for PCA
gam.estimated.smooths.long <- as.data.frame(gam.estimated.smooths.long)
gam.estimated.smooths.long <- sapply(gam.estimated.smooths.long, as.numeric)
```

PCA - variance explained by PC1
```{r}
smooths.pca <- prcomp(gam.estimated.smooths.long) 
summary(smooths.pca)$importance[2,1]
```

PCA - correlation with S-A axis
```{r}
PC1 <- smooths.pca$rotation[,1] #first principal component loadings
PC1 <- as.data.frame(PC1)
PC1$label <- row.names(PC1) #create label column
PC1$ranked <- rank(PC1$PC1)

PC1 <- left_join(PC1, S.A.axis, by = "label")
cor.test(PC1$PC1, PC1$SA.axis, method=c("spearman"))
```

```{r}
ggplot(PC1, aes(x=SA.axis, y=PC1, fill = SA.axis)) + 
geom_point(color = "white",shape=21, size=3.7) +
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180) +
labs(x="\nSensorimtor-Association Axis", y="Development PC1\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")
```

PCA - brain map 
```{r}
ggseg(.data = PC1, atlas = "glasser", mapping=aes(fill=PC1), position = c("stacked")) + theme_void() + paletteer::scale_fill_paletteer_c("grDevices::Inferno", limits = c(-.08,.08), oob=squish) + theme(legend.position = "none")
  
ggseg(.data = PC1, atlas = "glasser", mapping=aes(fill=PC1), position = c("stacked")) + theme_void() + 
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = -0.055, limits = c(-0.1,0.01), oob = squish) + theme(legend.position = "none")
```

# The Neurodevelopmental Hierarchy is Dominant through Adolescence

## Age-specific fluctuation amplitude derivatives

```{r}
gam.derivatives.glasser.lh <- gam.derivatives.glasser[33401:67200,]
ggplot(gam.derivatives.glasser.lh,aes(age,derivative,group=index,color=SA.axis)) + 
  geom_line(size=1, alpha = .7) + 
  scale_color_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "color", name = NULL, midpoint = 180) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "\nAge", y = "Derivative\n", color = "Sensorimotor-Association Axis Bin") +
  theme(axis.text = element_text(size=15, family = "Arial", color = c("black")), axis.title = element_text(size=15, family = "Arial", color = c("black"))) +
  scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), expand = c(0,.45))
```

ranked derivatives: age 10
```{r}
age10.derivs <- gam.derivatives.glasser %>% filter(age == 10.030)
age10.derivs$derivative <- rank(age10.derivs$derivative)
ggseg(.data = age10.derivs, atlas = "glasser", mapping=aes(fill=derivative), position = c("stacked"), hemisphere = "right") + 
  theme_void() + 
  scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 168)
rm(age10.derivs)
```

ranked derivatives: age 15
```{r}
age15.derivs <- gam.derivatives.glasser %>% filter(age == 15.024)
age15.derivs$derivative <- rank(age15.derivs$derivative)
ggseg(.data = age15.derivs, atlas = "glasser", mapping=aes(fill=derivative), position = c("stacked"), hemisphere = "right") + 
  theme_void() + 
  scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 168)
rm(age15.derivs)
```

ranked derivatives: age 20
```{r}
age20.derivs <- gam.derivatives.glasser %>% filter(age == 20.018)
age20.derivs$derivative <- rank(age20.derivs$derivative)
ggseg(.data = age20.derivs, atlas = "glasser", mapping=aes(fill=derivative), position = c("stacked"), hemisphere = "right") + 
  theme_void() + 
  scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 168)
rm(age20.derivs)
```

Long derivative plot
```{r}
ggplot(data=gam.derivatives.glasser,aes(x=age,y=SA.axis,group=index))+
  geom_line(aes(color=significant.derivative),size=1)+
  paletteer::scale_color_paletteer_c("grDevices::Inferno", limits=c(-0.03,0.03), oob = squish, direction = -1)+
  theme_classic()+
  ylab("Sensorimotor-Association Axis Rank")+
  xlab("Age")+
  labs(color="Change per year\n") +
  theme(axis.text.x = element_text(size = 12, color = c("black"))) +
  theme(axis.text.y = element_text(size = 12, color = c("black"))) 
```

## Age-specific correlation between derivates and the S-A Axis

```{r}
deriv.SAaxis.cor <- gam.derivatives.glasser %>% group_by(age) %>% do(SA.correlation = cor(.$derivative,.$SA.axis, method = c("spearman"))) %>% unnest(SA.correlation) #calculate the correlation between regional fluctuation amplitude change and sensorimotor-association axis rank at each age increment

deriv.SAaxis.posteriorcor <- read.table("/cbica/projects/spatiotemp_dev_plasticity/FluctuationAmplitude/GAMRESULTS/SAaxis_posteriorderivative_correlation_byage_glasser.csv", header = F, sep = ",") #get the above correlation for all draws from the posterior distribution
colnames(deriv.SAaxis.posteriorcor) <- sprintf("draw%s",seq(from = 1, to = ncol(deriv.SAaxis.posteriorcor)))
deriv.SAaxis.posteriorcor$age <- deriv.SAaxis.cor$age
```

Age of maximal S-A axis correlation: posterior median value + 95% credible interval 
```{r}
age.max.corr <- deriv.SAaxis.posteriorcor %>% #find the age at which the correlation is largest for each draw
    summarise(across(contains("draw"),
                     .fns = function(x){
                       round(deriv.SAaxis.posteriorcor$age[which.max(x)],4)
                     }))
age.max.corr <- t(age.max.corr)
age.max.corr.median <- median(age.max.corr) #median age #bayes
age.max.corr.CI <- quantile(age.max.corr, probs = c(0.025, 0.975)) #compute the credible interval based on all draws
age.max.corr.lower <- age.max.corr.CI[[1]]
age.max.corr.upper <- age.max.corr.CI[[2]]
```

S-A axis correlation value at each age: posterior median values + 95% credible interval 
```{r}
deriv.SAaxis.posteriorcor <- deriv.SAaxis.posteriorcor %>% select(contains("draw"))

deriv.SAaxis.mediancor <- apply(deriv.SAaxis.posteriorcor, 1, function(x){median(x)}) #median correlation value at each age

cor.credible.intervals <- apply(deriv.SAaxis.posteriorcor, 1, function(x){quantile(x, probs = c(0.025, 0.975))}) #compute the credible interval for the correlation value at each age based on all draws
cor.credible.intervals <- t(cor.credible.intervals)
cor.credible.intervals <- as.data.frame(cor.credible.intervals)
cor.credible.intervals$age <- deriv.SAaxis.cor$age
cor.credible.intervals$SA.correlation <- deriv.SAaxis.mediancor 
colnames(cor.credible.intervals) <- c("lower","upper","age","SA.correlation")
```

```{r}
cor.credible.intervals$max.corr.CI <- (cor.credible.intervals$age > age.max.corr.lower & cor.credible.intervals$age < age.max.corr.upper) #add a column that indicates whether each age is included in the age of maximal correlation credible interval (T/F)
cor.credible.intervals$max.cor.window <- cor.credible.intervals$age*cor.credible.intervals$max.corr.CI #add a column that only includes ages in this interval
cor.credible.intervals$max.cor.window[cor.credible.intervals$max.cor.window == 0] <- NA
                        
cor.credible.intervals$zero.corr.CI <- (cor.credible.intervals$lower < 0 & cor.credible.intervals$upper > 0) #add a column that indicates whether the credible interval for the correlation includes 0
cor.credible.intervals$zero.corr.window <- cor.credible.intervals$age*cor.credible.intervals$zero.corr.CI #add a column that only includes ages in the zero window
cor.credible.intervals$zero.corr.window[cor.credible.intervals$zero.corr.window == 0] <- NA
```

Sensorimotor-Association Axis Development Sliding Window Plot
```{r}
ggplot(cor.credible.intervals, aes(x = age, y = SA.correlation, ymin = lower, ymax = upper)) + 
geom_line(size=1.5) +
geom_ribbon(alpha=.2, fill=c("grey30")) +
labs(x="\nAge", y="Developmental Alignment the Axis\n") +
geom_ribbon(aes(x = max.cor.window, y = SA.correlation), fill="#aba3e6") +
geom_ribbon(aes(x = zero.corr.window, y = SA.correlation), fill="#280854") +  
theme(
axis.title.x=element_text(size=26, color = "black"),
axis.title.y=element_text(size=26, color = "black"),
axis.line = element_line(color = "black"),
axis.text=element_text(size=26, color = "black"),
panel.background=element_blank(),legend.position = "none") +
scale_y_continuous(breaks=c(0,0.2,0.4,0.6)) +
scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), limits = c(8, 23), expand = c(0,0))
```

# Fluctuation Amplitude Variability is Linked to Variability in the Developmental Environment

## Significant associations between fluctuation amplitude and environmental factor

Number of cortical regions showing significant environment effects

* original model
```{r}
sum(p.adjust(df.env$Anova.env.pvalue, method=c("fdr")) < 0.05) 
```

* controlling for parental education
```{r}
sum(p.adjust(df.env$Anova.env.edu.pvalue, method=c("fdr")) < 0.05)
```

Percent of cortical regions showing significant environment effects

* original model
```{r}
(sum(p.adjust(df.env$Anova.env.pvalue, method=c("fdr")) < 0.05))/(nrow(df.env))*100 
```

* controlling for parental education
```{r}
(sum(p.adjust(df.env$Anova.env.edu.pvalue, method=c("fdr")) < 0.05))/(nrow(df.env))*100 
```

Across-cortex environment effect size and direction
```{r, warning=F, message=F}
df.env$GAM.env.partialR2.significant <- df.env$GAM.env.partialR2*(p.adjust(df.env$Anova.env.pvalue, method=c("fdr")) < 0.05)
df.env$GAM.env.partialR2.significant[df.env$GAM.env.partialR2.significant == 0] <- NA
df.env$GAM.env.edu.partialR2.significant <- df.env$GAM.env.edu.partialR2*(p.adjust(df.env$Anova.env.edu.pvalue, method=c("fdr")) < 0.05)
df.env$GAM.env.edu.partialR2.significant[df.env$GAM.env.edu.partialR2.significant == 0] <- NA
  
ggseg(.data = df.env, atlas = "glasser", mapping=aes(fill=GAM.env.tvalue), position = c("stacked")) + 
  theme_void() + 
  labs(fill="Age Effect") +
  scale_fill_gradient2(low= "#F4A674", mid = "white", high = "#952162", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 0, limits=c(-4,4), oob=squish)
#paletteer::scale_fill_paletteer_c("grDevices::PuOr")
#aletteer::scale_fill_paletteer_c("grDevices::RdYlBu")
```

Correlation between fluctuation amplitude age effects and the sensorimotor-association axis

* original model
```{r}
cor.test(df.env$GAM.env.tvalue, df.env$SA.axis, method=c("spearman"))
perm.sphere.p(df.env.spin$GAM.env.partialR2, df.env.spin$SA.axis, perm.id.full,corr.type='spearman')
cor.test(df.env$GAM.env.partialR2.significant, df.env$SA.axis, method=c("spearman"))
```

Correlation plot
```{r}
ggplot(df.env, aes(x=SA.axis, y=GAM.env.tvalue, fill = SA.axis)) + 
geom_point(color = "white",shape=21, size=3.7) +
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180) +
labs(x="\nSensorimtor-Association Axis", y="Environment Effect\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")

ggplot(df.env, aes(x=SA.axis, y=GAM.env.partialR2, fill = SA.axis)) + 
geom_point(color = "white",shape=21, size=3.7) +
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180) +
labs(x="\nSensorimtor-Association Axis", y="Environment Effect\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")

ggplot(df.env, aes(x=SA.axis, y=GAM.env.partialR2.significant, fill = SA.axis)) + 
geom_point(color = "white",shape=21, size=3.7) +
scale_fill_gradient2(low= "goldenrod1", mid = "white", high = "#6f1282", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 180) +
labs(x="\nSensorimtor-Association Axis", y="Environment Effect\n") +
geom_smooth(method='lm', se=TRUE, fill=alpha(c("gray70"),.7), col="black") +
theme(
axis.title.x=element_text(size=15, family ="Arial", color = c("black")),
axis.title.y=element_text(size=15, family ="Arial", color = c("black")),
axis.line = element_line(color = "black"),
axis.text=element_text(size=15, family ="Arial", color = c("black")),
panel.background=element_blank(),
legend.position = "none")
```

* controlling for parental education
```{r}
cor.test(df.env$GAM.env.edu.partialR2, df.env$SA.axis, method=c("spearman"))
cor.test(df.env$GAM.env.edu.partialR2.significant, df.env$SA.axis, method=c("spearman"))
```